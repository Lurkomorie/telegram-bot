# Language Mixing Fix

## Problem
Персонаж отвечал на двух языках одновременно, смешивая английский и русский в одном сообщении:

```
I pop my head out from behind a tree, ears perked up, tail held high. Привет! I purr softly, Я вижу, ты снова здесь!
```

## Root Cause
1. Промпт был недостаточно строгим о запрете смешивания языков
2. Не было явных примеров НЕПРАВИЛЬНЫХ ответов
3. LLM полагалась на автоматическое определение языка из контекста, но это не всегда работало

## Solution
Вместо попыток программно определять язык, усилили инструкции в промпте:

### 1. Обновлён `config/prompts.py` - секция `<LanguageRules>`
- Добавлено **CRITICAL** правило: весь ответ должен быть на ОДНОМ языке
- Явный запрет на смешивание: "NEVER MIX LANGUAGES"
- Чёткие инструкции для каждого языка

### 2. Обновлена `<LanguageEnforcementChecklist>`
- Добавлена пошаговая проверка перед отправкой
- Добавлены конкретные примеры НЕПРАВИЛЬНЫХ ответов (❌)
- Добавлены примеры ПРАВИЛЬНЫХ ответов (✅)
- Инструкция переписать весь ответ если обнаружено смешивание

### 3. Усилена секция автоматических сообщений
В `app/core/brains/dialogue_specialist.py` добавлено правило:
```
- **CRITICAL**: Write in the SAME LANGUAGE as the previous conversation. NO mixed languages.
```

## Technical Changes

### File: `config/prompts.py`
- Lines 42-51: Переписана секция `<LanguageRules>` с более строгими инструкциями
- Lines 53-68: Переписана секция `<LanguageEnforcementChecklist>` с примерами

### File: `app/core/brains/dialogue_specialist.py`
- Line 39: Изменено `{{user.lang}}` с жёсткого "en" на "[detect from conversation]"
- Line 132: Добавлено критическое правило о языке для auto-followup сообщений

## Expected Result
LLM теперь:
1. Автоматически определяет язык из контекста разговора
2. Проверяет свой ответ перед отправкой
3. НЕ смешивает языки в одном сообщении
4. Локализует ВСЁ - действия, диалоги, звуки

## Testing
После применения изменений, протестируйте:
1. Начните разговор на русском → ответ должен быть полностью на русском
2. Начните разговор на английском → ответ должен быть полностью на английском
3. Переключитесь на другой язык → бот должен следовать новому языку



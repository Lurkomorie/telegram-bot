# Изменения системы рефреша и энергии

## Дата: 22 января 2026

### 1. Снижение энергии с 100 до 80

**Измененные файлы:**
- `app/db/models.py` - изменены значения по умолчанию для `energy` и `max_energy`
- `app/db/migrations/versions/029_reduce_max_energy_to_80.py` - новая миграция

**Изменения:**
- Начальная энергия для новых пользователей: 100 → 80
- Максимальная энергия: 100 → 80
- Существующие пользователи с энергией 100 будут обновлены до 80 при миграции

### 2. Новая логика рефреша изображений

**Измененные файлы:**
- `app/bot/handlers/image.py`

**Логика:**
1. **Первый рефреш (refresh_count = 0):**
   - Генерируется новое изображение с теми же промптами
   - Изменяется только seed
   - Стоимость: 3 энергии для бесплатных пользователей, 0 для премиум

2. **Второй и последующие рефреши (refresh_count >= 1):**
   - Генерируется только текстовый ответ (без изображения)
   - Используется dialogue specialist для генерации нового текста
   - Стоимость: 3 энергии для бесплатных пользователей, 0 для премиум

**Отслеживание:**
- `refresh_count` хранится в `job.ext`
- Увеличивается при каждом рефреше
- Используется для определения типа ответа (изображение или текст)

### 3. Новые функции

**В `app/bot/handlers/image.py`:**
- `generate_text_only_refresh()` - генерирует текстовый ответ без изображения
- Обновлена `generate_image_for_refresh()` - теперь отслеживает `refresh_count`
- Обновлена `refresh_image_callback()` - проверяет `refresh_count` и выбирает тип ответа

**В `app/core/analytics_service_tg.py`:**
- `track_text_refresh()` - отслеживает текстовые рефреши

### 4. Аналитика

**Новые события:**
- `text_refresh` - отслеживает второй и последующие рефреши (только текст)
- Существующее событие `image_refresh` используется для первого рефреша (с изображением)

**Метаданные:**
- `original_job_id` - ID оригинальной работы
- `refresh_count` - количество рефрешей
- `persona_id` и `persona_name` - информация о персонаже

### 5. Миграция базы данных

**Файл:** `app/db/migrations/versions/029_reduce_max_energy_to_80.py`

**Действия при upgrade:**
1. Изменяет server_default для `energy` и `max_energy` на 80
2. Обновляет существующих пользователей с энергией 100 до 80

**Действия при downgrade:**
1. Возвращает server_default на 100
2. Возвращает энергию пользователей с 80 на 100

### 6. Применение изменений

```bash
# Применить миграцию
alembic upgrade head

# Откатить миграцию (если нужно)
alembic downgrade -1
```

### 7. Тестирование

Создан тестовый скрипт `test_refresh_logic.py` для проверки логики изменений.

```bash
python test_refresh_logic.py
```

## Примечания

- Все изменения обратно совместимы
- Существующие изображения без `refresh_count` будут считаться как 0 (первый рефреш)
- Стоимость рефреша остается 3 энергии для бесплатных пользователей
- Премиум пользователи могут рефрешить бесплатно

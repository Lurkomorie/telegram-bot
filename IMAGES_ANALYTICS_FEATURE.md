# Images Analytics Feature

## Overview
Added a comprehensive images analytics page to the analytics dashboard that displays all generated images with pagination, filtering by source (message response, scheduler, history start), and detailed information about each image.

## Implementation Summary

### Backend Changes

#### 1. Database Layer (`app/db/crud.py`)
- **New Function**: `get_all_images_paginated(db, page, per_page)`
  - Fetches all `image_generated` events from analytics with pagination
  - Returns 100 images per page by default (configurable up to 500)
  - Includes user information (username, first_name, user_id)
  - Includes persona information (persona_name, persona_id)
  - Determines image source from metadata:
    - `history_start`: Initial greeting images
    - `scheduler`: Auto-followup/scheduled messages
    - `message_response`: Regular message responses (default)
  - Returns pagination metadata (total, page, per_page, total_pages)

#### 2. API Layer (`app/api/analytics.py`)
- **New Endpoint**: `GET /api/analytics/images`
  - Query parameters:
    - `page`: Page number (1-indexed, default: 1)
    - `per_page`: Items per page (default: 100, max: 500)
  - Returns paginated list of images with full metadata
  - Validates and caps pagination parameters

#### 3. Image Source Tracking

##### Modified: `app/core/multi_brain_pipeline.py`
- Updated `_process_single_batch()` to pass `is_auto_followup` flag to image generation
- Updated `_background_image_generation()` to:
  - Accept `is_auto_followup` parameter
  - Store `is_auto_followup` in ImageJob.ext metadata field
  - This allows tracking whether an image was generated from scheduler vs regular message

##### Modified: `app/main.py`
- Updated `/image/callback` endpoint to:
  - Extract `is_auto_followup` from ImageJob.ext metadata
  - Pass it to analytics tracking

##### Modified: `app/core/analytics_service_tg.py`
- Updated `track_image_generated()` to accept `is_auto_followup` parameter
- Updated `_upload_and_track_image()` to:
  - Accept `is_auto_followup` parameter
  - Include it in analytics event metadata
  - This metadata is used to determine image source in the analytics dashboard

### Frontend Changes

#### 1. API Client (`analytics-dashboard/src/api.js`)
- **New Method**: `getImages(page, perPage)`
  - Fetches paginated images from backend
  - Default: page=1, perPage=100

#### 2. Images Component (`analytics-dashboard/src/components/Images.jsx`)
- **New Component**: Comprehensive images list view
- **Features**:
  - Paginated table display (100 images per page)
  - Columns:
    - Preview thumbnail (clickable)
    - Date/time
    - User (name, username, ID)
    - Persona
    - Source badge (color-coded)
    - Prompt preview
  - **Source Badges**:
    - üü¢ Message Reply (green)
    - üü£ Auto-Message (purple)
    - üîµ History Start (blue)
  - **Pagination Controls**:
    - First/Previous/Next/Last buttons
    - Page numbers (shows 5 pages at a time)
    - Current page indicator
  - **Image Modal**:
    - Click any image to view full details
    - Shows full-size image
    - Displays all metadata (date, user, persona, source, prompts, URL)
    - Close button and click-outside-to-close
  - **Loading States**: Skeleton loaders
  - **Error Handling**: User-friendly error messages

#### 3. Navigation (`analytics-dashboard/src/App.jsx`)
- Added `/images` route mapping to Images component
- Imported Images component

#### 4. Sidebar (`analytics-dashboard/src/components/Sidebar.jsx`)
- Added "Images" navigation link with üñºÔ∏è icon
- Link highlights when active

## Data Flow

### Image Generation Flow
1. User sends message ‚Üí Multi-brain pipeline processes
2. Pipeline determines if it's an auto-followup (`is_auto_followup` flag)
3. Image job created with metadata: `ext: {"is_auto_followup": true/false}`
4. Image generated by RunPod
5. Callback endpoint extracts `is_auto_followup` from job metadata
6. Analytics tracking receives `is_auto_followup` flag
7. Event stored in `tg_analytics_events` table with metadata

### Analytics Query Flow
1. Frontend requests images via API
2. Backend queries `tg_analytics_events` where `event_name = 'image_generated'`
3. For each event:
   - Fetch user details from `users` table
   - Parse metadata to determine source:
     - Check `meta.source == 'history_start'` ‚Üí History Start
     - Check `meta.is_auto_followup == true` ‚Üí Scheduler
     - Otherwise ‚Üí Message Response
4. Return paginated results with enriched data

## Source Classification Logic

The system classifies image sources using metadata:

```python
# In crud.py
if img_event.meta.get('source') == 'history_start':
    source = 'history_start'
elif img_event.meta.get('is_auto_followup'):
    source = 'scheduler'
else:
    source = 'message_response'  # default
```

## API Response Format

```json
{
  "images": [
    {
      "id": "uuid",
      "created_at": "2025-11-08T12:34:56",
      "image_url": "https://cloudflare.url/image.png",
      "prompt": "Full SDXL prompt...",
      "negative_prompt": "Negative prompt...",
      "source": "scheduler",
      "user_id": 123456789,
      "username": "john_doe",
      "first_name": "John",
      "persona_id": "uuid",
      "persona_name": "Sweet Girlfriend",
      "meta": {
        "chat_id": "uuid",
        "job_id": "uuid",
        "is_auto_followup": true,
        "cloudflare_upload_success": true
      }
    }
  ],
  "total": 1523,
  "page": 1,
  "per_page": 100,
  "total_pages": 16
}
```

## UI Features

### Table View
- **Responsive Design**: Scrollable table on smaller screens
- **Hover Effects**: Row highlighting on hover
- **Truncated Text**: Prompts show preview with full text on hover
- **Thumbnails**: 64x64px previews, clickable to view full image
- **User Display**: Shows name or "Unknown", username or ID fallback
- **Date Formatting**: User-friendly date/time format

### Pagination
- **Smart Page Numbers**: Shows 5 pages at a time, centered around current page
- **Navigation**: First, Previous, Next, Last buttons
- **Disabled States**: Buttons disabled at boundaries
- **Info Display**: "Showing X of Y images (Page N of M)"
- **Smooth Scrolling**: Auto-scroll to top on page change

### Image Modal
- **Full-Screen Overlay**: Dark backdrop
- **Responsive Sizing**: Max 5xl width, auto height
- **Detailed View**: All metadata displayed
  - Creation date/time
  - User info (name, username, ID)
  - Persona name
  - Source badge
  - Full prompt and negative prompt
  - Clickable image URL
- **User-Friendly Closing**: X button + click outside

## Testing Recommendations

1. **Backend Testing**:
   - Test pagination with various page sizes
   - Verify source classification for all three types
   - Test with missing user data (deleted users)
   - Test with large datasets (performance)

2. **Frontend Testing**:
   - Test pagination edge cases (first page, last page, single page)
   - Test image modal opening/closing
   - Test with images that have no URL (fallback)
   - Test responsive design on mobile devices
   - Test loading and error states

3. **Integration Testing**:
   - Generate images through regular messages
   - Generate images through scheduler (wait for auto-followup)
   - Generate images from history start
   - Verify all three types appear correctly in analytics

## Future Enhancements

Potential improvements:

1. **Filtering**:
   - Filter by source type
   - Filter by user
   - Filter by persona
   - Date range filtering

2. **Search**:
   - Search by prompt text
   - Search by user

3. **Bulk Actions**:
   - Download multiple images
   - Export to CSV/JSON

4. **Statistics**:
   - Image generation rate over time
   - Most popular personas by image count
   - Source distribution pie chart

5. **Performance**:
   - Implement virtual scrolling for large lists
   - Add caching layer
   - Optimize database queries with indexes

## Files Modified

### Backend
- `app/db/crud.py` - Added `get_all_images_paginated()`
- `app/api/analytics.py` - Added `/api/analytics/images` endpoint
- `app/core/multi_brain_pipeline.py` - Added `is_auto_followup` tracking
- `app/main.py` - Updated image callback to pass source metadata
- `app/core/analytics_service_tg.py` - Updated tracking functions

### Frontend
- `analytics-dashboard/src/components/Images.jsx` - New component
- `analytics-dashboard/src/api.js` - Added `getImages()` method
- `analytics-dashboard/src/App.jsx` - Added route
- `analytics-dashboard/src/components/Sidebar.jsx` - Added navigation link

## Database Schema

No database migrations required! The implementation uses existing tables:
- `tg_analytics_events` - Stores image generation events
- `image_jobs` - Stores job metadata (ext field)
- `users` - User information
- `personas` - Persona information

The `ext` JSONB field on `image_jobs` and `meta` JSONB field on `tg_analytics_events` provide flexibility for storing source metadata without schema changes.

